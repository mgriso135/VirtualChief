@model KIS.App_Code.Articolo

@{
    ViewBag.Title = ResProductDetails.Index.lblTitle;
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<h3>@ResProductDetails.Index.lblNavProductionSchedule</h3>

<ul class="breadcrumb hidden-phone">
    <li>
        <a href="~/Production/ProductionSchedule/Index">
            @ResProductDetails.Index.lblNavProductionSchedule
        </a>
        <span class="divider">/</span>
        <a href="@Request.RawUrl>">@ResProductDetails.Index.lblTitle</a>
        <span class="divider">/</span>
    </li>
</ul>

@if (ViewBag.authR)
{
    if (Model != null && Model.ID != -1 && Model.Year > 2010)
    {
        <script>
            $(document).ready(function () {
                $("#tblTasks").on("click", ".btnParams", function () {
                    var task = $(this).val();
                    if ($.isNumeric(task) && task >= 0) {
                        $.ajax({
                            url: "@Url.Action("ViewTaskParameters", "ProductDetails")",
                            type: 'POST',
                            data: {
                                TaskID: task
                            },
                            success: function (data) {
                                var ifrmWI = "<div style='overflow-y:auto;left: 20%; border: 0px none; height: 50%; position: fixed; width: 70%; top:30%;background-color:rgba(255, 255, 255, 0.85);' id='viewParameters'>"
                                    + "<input type='image' src='../img/iconClose.png' id='imgClosePdf' style='max-width:30px; min-width:30px; position:relative;top:0px;overflow-y:auto;' />"
                                    + "<div style='position:relative;top:0px;left: 100px;'>" + data
                                    + "</div>"
                                    + "</div>";
                                $("#iframeWI").html(ifrmWI);
                                $("#iframeWI").fadeIn();
                            },
                            statusCode: {
                                404: function (content) { alert('cannot find resource'); },
                                500: function (content) { alert('internal server error'); }
                            },
                            error: function (data) {
                                alert("Error");
                            }


                        });
                    }
                    else {
                        alert("Error");
                    }
                });

                $("#tblTasks").on("click", ".btnOpNotes", function () {
                    var task = $(this).val();
                    if ($.isNumeric(task) && task >= 0) {
                        $.ajax({
                            url: "@Url.Action("ViewTaskOperatorNotes", "ProductDetails")",
                            type: 'POST',
                            data: {
                                TaskID: task
                            },
                            success: function (data) {
                                var ifrmWI = "<div style='overflow-y:auto;left: 20%; border: 0px none; height: 50%; position: fixed; width: 70%; top:30%;background-color:rgba(255, 255, 255, 0.85);' id='viewParameters'>"
                                    + "<input type='image' src='../img/iconClose.png' id='imgClosePdf' style='max-width:30px; min-width:30px; position:relative;top:0px;overflow-y:auto;' />"
                                    + "<div style='position:relative;top:0px;left: 100px;'>" + data
                                    + "</div>"
                                    + "</div>";
                                $("#iframeWI").html(ifrmWI);
                                $("#iframeWI").fadeIn();
                            },
                            statusCode: {
                                404: function (content) { alert('cannot find resource'); },
                                500: function (content) { alert('internal server error'); }
                            },
                            error: function (data) {
                                alert("Error");
                            }


                        });
                    }
                    else {
                        alert("Error");
                    }
                });


                $("#tblTasks").on("click", ".btnViewTaskDetail", function () {
                    var task = $(this).val();
                    if ($.isNumeric(task) && task >= 0) {
                        $.ajax({
                            url: "@Url.Action("ViewTaskOperationsDetails", "ProductDetails")",
                            type: 'POST',
                            data: {
                                TaskID: task
                            },
                            success: function (data) {
                                var ifrmWI = "<div style='overflow-y:auto;left: 20%; border: 0px none; height: 50%; position: fixed; width: 70%; top:30%;background-color:rgba(255, 255, 255, 0.85);' id='viewParameters'>"
                                    + "<input type='image' src='../img/iconClose.png' id='imgClosePdf' style='max-width:30px; min-width:30px; position:relative;top:0px;overflow-y:auto;' />"
                                    + "<div style='position:relative;top:0px;left: 100px;'>" + data
                                    + "</div>"
                                    + "</div>";
                                $("#iframeWI").html(ifrmWI);
                                $("#iframeWI").fadeIn();
                            },
                            statusCode: {
                                404: function (content) { alert('cannot find resource'); },
                                500: function (content) { alert('internal server error'); }
                            },
                            error: function (data) {
                                alert("Error");
                            }


                        });
                    }
                    else {
                        alert("Error");
                    }
                });

                $("#iframeWI").on("click", "#imgClosePdf", function () {
                    $("#iframeWI").fadeOut();
                });

                $("#tblTasks").on("click", ".btnExhumateTask", function () {
                    var btn = $(this);
                    var task = $(this).val();
                    if ($.isNumeric(task) && task >= 0) {
                        $.ajax({
                            url: "@Url.Action("ExhumateTask", "ProductDetails")",
                            type: 'POST',
                            data: {
                                TaskID: task
                            },
                            success: function (data) {
                                if (data == "True") {
                                    location.reload(true);
                                }
                                else {
                                    alert("@ResProductDetails.Index.lblExhumateError");
                                    $(this).fadeIn();
                                }
                            },
                            statusCode: {
                                404: function (content) { alert('cannot find resource'); },
                                500: function (content) { alert('internal server error'); }
                            },
                            error: function (data) {
                                alert("Error");
                            }


                        });
                    }
                    else {
                        alert("Error");
                    }
                });
            });
        </script>

        <h3>@ResProductDetails.Index.lblTitle</h3>
        <div class="row-fluid">
            <div class="span12">
                <table class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th>@ResProductDetails.Index.lblTHCustomer</th>
                            <th>@ResProductDetails.Index.lblTHSalesOrderID</th>
                            <th>@ResProductDetails.Index.lblTHProductionOrderID</th>
                            <th>@ResProductDetails.Index.lblTHProductID</th>
                            <th>@ResProductDetails.Index.lblTHProductName</th>
                            @if (Model.Matricola != null && Model.Matricola.Length > 0)
                            {
                                <th>@ResProductDetails.Index.lblTHSerialNumber</th>
                            }
                            <th>@ResProductDetails.Index.lblTHDepartment</th>
                            <th>@ResProductDetails.Index.lblStatus</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>@Model.RagioneSocialeCliente</td>
                            @if (Model.CommessaExternalID.Length > 0)
                            {
                                <td>@Model.CommessaExternalID</td>
                            }
                            else
                            {
                                <td>@Model.Commessa/@Model.AnnoCommessa</td>
                            }
                            <td>
                                @Model.ID/@Model.Year
                            </td>
                            <td>
                                @Model.ProductExternalID
                            </td>
                            <td>@Model.Proc.process.processName - @Model.Proc.variant.nomeVariante</td>
                            @if (Model.Matricola != null && Model.Matricola.Length > 0)
                            {
                                <td>@Model.Matricola</td>
                            }
                            <td>@Model.RepartoNome</td>
                            @if (Model.Status == 'F')
                            {
                                <td>@ResProductDetails.Index.lblF</td>
                            }
                            else if (Model.Status == 'I')
                            {
                                <td>@ResProductDetails.Index.lblI</td>
                            }
                            else if (Model.Status == 'N')
                            {
                                <td>@ResProductDetails.Index.lblN</td>
                            }
                            else if (Model.Status == 'P')
                            {
                                <td>@ResProductDetails.Index.lblP</td>
                            }

                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        if (Model.Status == 'F')
        {
            <div class="row-fluid">
                <div class="span12">
                    <table class="table table-hover table-striped">
                        <thead>
                            <tr>
                                <th style="text-align:center;">@ResProductDetails.Index.lblEndProductionPlanned</th>
                                <th style="text-align:center;">@ResProductDetails.Index.lblEndProductionReal</th>
                                <th style="text-align:center;">@ResProductDetails.Index.lblDelay</th>
                                <th style="text-align:center;">@ResProductDetails.Index.lblLeadTime</th>
                                <th style="text-align:center;">@ResProductDetails.Index.lblWorkingTimePlanned</th>
                                <th style="text-align:center;">@ResProductDetails.Index.lblWorkingTimeReal</th>
                                <th style="text-align:center;">@ResProductDetails.Index.lblDeviation</th>
                                <th style="text-align:center;">@ResProductDetails.Index.lblProductivity</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td style="text-align:center;">@Model.LateFinish.ToString("dd/MM/yyyy HH:mm:ss")</td>
                                <td style="text-align:center;">@Model.EndProductionDateReal.ToString("dd/MM/yyyy HH:mm:ss")</td>
                                <td style="text-align:center;">@Math.Round(Model.Delay.TotalHours, 2)</td>
                                <td style="text-align:center;">@Math.Round(Model.LeadTime.TotalHours, 2)</td>
                                <td style="text-align:center;">@Math.Round(Model.PlannedWorkingTime.TotalHours, 2)</td>
                                <td style="text-align:center;">@Math.Round(Model.WorkingTime.TotalHours, 2)</td>
                                @{ 
                                    var prodBgColor = Model.WorkingTime.TotalHours > Model.PlannedWorkingTime.TotalHours ? "#FF0000" : "#00FF00";
                                }
                                <td style="text-align:center;"><div style="background-color: @prodBgColor"><b>@Math.Round((Model.WorkingTime.TotalHours - Model.PlannedWorkingTime.TotalHours), 2)</b></div></td>
                                <td style="text-align:center;"><div style="background-color: @prodBgColor"><b>@Math.Round((Model.Productivity * 100), 2)%</b></div></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        }

        <div class="row-fluid">
            <div class="span12">
                <table class="table table-striped table-hover" id="tblTasks">
                    <thead>
                        <tr>
                            <th>@ResProductDetails.Index.lblTHTaskID</th>
                            <th>@ResProductDetails.Index.lblTHTaskName</th>
                            <th>@ResProductDetails.Index.lblStatus</th>
                            <th>@ResProductDetails.Index.lblTHTaskWorkstation</th>
                            <th>@ResProductDetails.Index.lblTHTaskPlannedStart</th>
                            <th>@ResProductDetails.Index.lblTHTaskRealStart</th>
                            <th>@ResProductDetails.Index.lblTHTaskPlannedEnd</th>
                            <th>@ResProductDetails.Index.lblTHTaskRealEnd</th>
                            <th>@ResProductDetails.Index.lblDelay</th>
                            <th>@ResProductDetails.Index.lblTHPlannedWorkingHours</th>
                            <th>@ResProductDetails.Index.lblTHRealWorkingHours</th>
                            <th>@ResProductDetails.Index.lblDeviation</th>
                            <th>@ResProductDetails.Index.lblProductivity</th>
                            <th>@ResProductDetails.Index.lblTHTaskParameters</th>
                            <th>@ResProductDetails.Index.lblTHTaskOperatorNotes</th>
                            <th>@ResProductDetails.Index.lblOperationsDetails</th>
                            <th>@ResProductDetails.Index.lblTHExhumateTask</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var m in Model.Tasks)
                        {
                            var bgColor = "";
                            if (m.Status == 'F')
                            {
                                bgColor = "#00FF00";
                            }
                            else if (m.Status == 'I')
                            {
                                bgColor = "#0000FF";
                            }
                        <tr>
                            <td>@m.TaskProduzioneID</td>
                            <td>@m.Name</td>
                            @if (m.Status == 'F')
                            {
                                <td><div style="background-color: @bgColor;">@ResProductDetails.Index.lblF</div></td>
                            }
                            else if (m.Status == 'I')
                            {
                                <td><div style="background-color: @bgColor;">@ResProductDetails.Index.lblI</div></td>
                            }
                            else if (m.Status == 'N')
                            {
                                <td><div style="background-color: @bgColor;">@ResProductDetails.Index.lblN</div></td>
                            }
                            else if (m.Status == 'P')
                            {
                                <td><div style="background-color: @bgColor;">@ResProductDetails.Index.lblP</div></td>
                            }
                            <td>@m.PostazioneName</td>
                            <td>@m.EarlyStart.ToString("dd/MM/yyyy HH:mm:ss")</td>
                            @if (m.Status != 'N')
                            {
                                <td>@m.DataInizioTask.ToString("dd/MM/yyyy HH:mm:ss")</td>
                            }
                            else
                            {
                                <td></td>
                            }
                            <td>@m.LateFinish.ToString("dd/MM/yyyy HH:mm:ss")</td>
                            @if (m.Status == 'F')
                            {
                                <td>@m.RealEndDate.ToString("dd/MM/yyyy HH:mm:ss")</td>
                            }
                            else
                            {
                                <td></td>
                            }
                            @if (m.Status == 'F')
                            {
                                <td>@Math.Round(m.Delay.TotalHours, 2)</td>
                            }
                            else
                            {
                                <td></td>
                            }
                            <td>@Math.Round(m.TempoC.TotalHours, 2)</td>
                            @if (m.Status == 'F')
                            {
                                <td>@Math.Round(m.WorkingTime.TotalHours, 2)</td>
                            }
                            else
                            {
                                <td></td>
                            }
                            @if (m.Status == 'F')
                            {
                                var bgDeviation = m.WorkingTime.TotalHours > m.TempoC.TotalHours ? "#FF0000" : "#00FF00";
                                <td style="text-align:center;"><div style="background-color: @bgDeviation;"><b>@Math.Round(m.WorkingTime.TotalHours - m.TempoC.TotalHours, 2)</b></div></td>
                            }
                            else
                            {
                                <td></td>
                            }
                            @{
                                var productivity = m.Productivity;
                                var bgScost = productivity < 1 ? "#FF0000" : "#00FF00";
                                if (m.Status == 'F')
                                {
                                    <td style="text-align:center;"><div style="background-color: @bgScost;"><b>@Math.Round(100 * productivity, 2)%</b></div></td>
                                }
                                else
                                {
                                    <td></td>
                                }
                            }

                            @{ m.loadParameters();
                                if (m.Parameters.Count > 0)
                                {
                                    <td style="text-align: center;"><input type="image" src="~/img/iconParameters.png" id="btnParams_@m.TaskProduzioneID" value="@m.TaskProduzioneID" class="btnParams" style="min-width:20px; max-width:25px;" title="@ResProductDetails.Index.lblViewParameters" /></td>
                                }
                                else
                                {
                                    <td></td>
                                }
                            }
                            @{
                                m.loadTaskOperatorNotes();
                                if (m.TaskOperatorNotes.Count > 0)
                                {
                                    <td style="text-align: center;">
                                        <input type="image" src="~/img/iconOperatorNotes.png" id="btnOpNotes_@m.TaskProduzioneID" class="btnOpNotes" value="@m.TaskProduzioneID" style="min-width:20px; max-width:25px;" title="@ResProductDetails.Index.lblViewOperatorNotes" />
                                    </td>
                                }
                                else
                                {
                                    <td></td>
                                }
                            }
                            @if (m.Status != 'N')
                            {
                                <td><input type="image" src="~/img/iconView.png" id="btnViewTaskDetail_@m.TaskProduzioneID" class="btnViewTaskDetail" value="@m.TaskProduzioneID" style="min-width,:20px; max-width: 25px;" title="@ResProductDetails.Index.lblViewTaskDetails" /></td>
                            }
                            else
                            {
                                <td></td>
                            }
                            @if (m.Status == 'F')
                            {
                                <td><input type="image" src="~/img/iconExhume.png" id="btnExhumateTask_@m.TaskProduzioneID" class="btnExhumateTask" value="@m.TaskProduzioneID" style="min-width,:20px; max-width: 25px;" title="@ResProductDetails.Index.lblExhumateTaskTitle" /></td>
                            }
                            else
                            {
                                <td></td>
                            }
                        </tr>
                                }

                    </tbody>
                </table>
            </div>
        </div>
        <div id="iframeWI"></div>
    }
    else
    {
        <div class="row-fluid">
            <div class="span12">
                @ResProductDetails.Index.lblErrProductNotFound
            </div>
        </div>
    }

}
else
{
    <div class="row-fluid">
        <div class="span12">
            @ResProductDetails.Index.lblUserNotAuthorized
        </div>
    </div>
}