
@{
    ViewBag.Title = ResFreeMeasurements.Execute.lblTitle;
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<h3>@ResFreeMeasurements.Execute.lblTitle</h3>

@if (ViewBag.authW)
{
    if (ViewBag.DepartmentId != -1)
    {
<script src="https://cdnjs.cloudflare.com/ajax/libs/jinq/1.6.1/jinqjs.js" integrity="sha512-uui/aXrsWdhhxCo039xxseWZN5yLYjMJMQc8azPYAYOFmB5BtHy/jRWy2SEkFq6IYeSrQBIqfLIhX5cRdRG68w==" crossorigin="anonymous"></script>
        <script>

            $(document).ready(function () {
                var freemeasurementsjson;

            $("#btnChooseOperator").click(function () {
                var operator = $("#ddlOperator option:selected").val();
                console.log("Operator: " + operator);
                $("#dvStartTask").show();
            });

            function loadFreeMeasurements() {
                $.ajax({
                    url: "@Url.Action("GetFreeMeasurentsTasksJson", "FreeMeasurement")",
                    type: 'POST',
                    async: true,
                                data: {
                                    departmentId: @ViewBag.DepartmentId
                                },
                                success: function (data) {
                        console.log(data);
                                    console.log(typeof data);
                                    console.log(data.length);
                                    freemeasurementsjson = data;
                                    console.log(freemeasurementsjson);

                                    var measurements = new jinqJs().from(data)
                                        .distinct(['MeasurementId', 'MeasurementName'])
                                        .select(/*'MeasurementId', 'MeasurementName'*/);
                                    console.log(measurements);
                                   
                                    $('#ddlMeasurements').empty();
                                    $('#ddlMeasurements').append($('<option>', {
                                        value: "",
                                        text: ""
                                    }));
                                    for (var i = 0; i < measurements.length; i++) {
                                        $('#ddlMeasurements').append($('<option>', {
                                            value: measurements[i]["MeasurementId"],
                                            text: measurements[i]["MeasurementName"]
                                        }));
                                    }
                                },
                                statusCode: {
                                    404: function (content) { alert('cannot find resource'); },
                                    500: function (content) { alert('internal server error'); }
                                },
                                error: function (data) {
                                    alert("Error " + data);
                                }
                });
                setTimeout(loadFreeMeasurements, 60000);
            }

            function loadFreeMeasurementsTasks(measurementId)
            {
                console.log("loadFreeMeasurementsTasks");
                console.log(freemeasurementsjson);
                var measurements_tasks = new jinqJs().from(freemeasurementsjson)
                    .where('MeasurementId = ' + measurementId)
                    .select(/*'MeasurementId', 'TaskId', 'TaskName'*/);

                console.log(measurements_tasks);
            }

            $('#ddlMeasurements').on('change', function () {
                console.log("Change " + $(this).val());
                loadFreeMeasurementsTasks($(this).val());
            });

            loadFreeMeasurements();

        });
        </script>
        <div class="row-fluid">
            <div class="span12">
                @ResFreeMeasurements.Execute.lblChooseOperator
            <select id="ddlOperator">
                <option></option>
                @{
                    KIS.App_Code.Group opsGrp = new KIS.App_Code.Group("Operatori");
                    if (opsGrp.ID != -1)
                    {
                        opsGrp.loadUtenti();
                        foreach (var u in opsGrp.Utenti)
                        {
                            <option value="@u">@u</option>
                        }
                    }
                }
            </select>
            <span class="material-icons" style="cursor:pointer;" id="btnChooseOperator">arrow_forward_ios</span>
        </div>
    </div>

    <div class="row-fluid" id="dvStartTask" style="display:none;">
        <div class="span6">
            Choose productive task<br />
            <select id="ddlMeasurements">
                <option value=""></option>
            </select>
            <br />
            <select id="ddlTask">
                <option value=""></option>
            </select>
            <br />
            <input type="text" id="txtNewTask" />
        </div>
        <div class="span6">
            Choose NO productive task
            <br />
            <select id="ddlNoProductiveTasks">
                <option value=""></option>
                @{
                    KIS.App_Sources.NoProductiveTasks npList = new KIS.App_Sources.NoProductiveTasks();
                    foreach (var m in npList.TaskList)
                    {
                        <option value="@m.ID">@m.Name</option>
                    }
                }
            </select>
        </div>
    </div>

    <div class="row-fluid">
        <div class="span12">Running tasks</div>
    </div>
}
}
else
{
<div class="row-fluid">
    <div class="span12">
        @ResFreeMeasurements.Execute.lblUserNotAuthorized
    </div>
</div>
}