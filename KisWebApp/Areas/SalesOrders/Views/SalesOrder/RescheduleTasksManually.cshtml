@model IEnumerable<KIS.App_Code.TaskProduzione>

<h3>@ResAddSalesOrder.RescheduleTasksManually.lblTitle</h3>

@if (ViewBag.authW)
{
    <script>
        $(document).ready(function () {

            $("[id*=txtstartdate]").datepicker({
                dateFormat: 'dd/mm/yy',
                showWeek: true,
                firstDay: 1,
                minDate: 'today'
            });

            $("[id*=txtenddate]").datepicker({
                dateFormat: 'dd/mm/yy',
                showWeek: true,
                firstDay: 1,
                minDate: 'today'
            });

            $("#tblchangedates").on("change", ".txtstartdate", function () {
                var currObj = $(this);
                var spID = currObj.attr("id").split('_');
                var tskID = spID[1];
                if (tskID != null && tskID != -1) {
                    var tskDate = $(this).val();
                    var tskTime = $("#txtstarttime_" + tskID).val();
                    var aDate = tskDate.split('/');
                    var aTime = tskTime.split(':');
                    var startdate = new Date(aDate[2], aDate[1], aDate[0], aTime[0], aTime[1],0);
                    //alert(aDate[0] + "/" + aDate[1] + "/" + aDate[2] + " " + aTime[0] + ":" + aTime[1] + ":" + aTime[2]);
                    var now = new Date();

                    if (startdate > now) {
                        $("#txtenddate_" + tskID).prop('disabled', true);
                        $("#txtendtime_" + tskID).prop('disabled', true);
                        $("#changeTasksDates_" + tskID).fadeOut();
                        $.ajax({
                            url: "@Url.Action("GetFinishDateByStart", "SalesOrder")",
                            type: 'POST',
                            data: {
                                TaskID: tskID,
                                start: aDate[0] +"/"+ aDate[1] + "/"+ aDate[2] +" "+ aTime[0]+":"+ aTime[1]+":00"
                            },
                            success: function (result) {
                                var aRes = result.split(' ');
                                if (aRes != null && (aRes.length==2 || aRes.length==3)) {
                                    var aResDate = aRes[0];
                                    var aResTime = aRes[1];
                                    var sResDate = aResDate.split('/');
                                    var sResTime = aResTime.split(':');
                                    if (sResDate != null && sResTime != null && sResDate.length == 3 && (sResTime.length == 3||sResTime.length==2)) {
                                        var newenddate = new Date(sResDate[2], sResDate[1], sResDate[0], sResTime[0], sResTime[1], 0);
                                        if (newenddate > now && newenddate >= startdate) {
                                            $("#txtenddate_" + tskID).val(sResDate[1] + "/" + sResDate[0] + "/" + sResDate[2]);
                                            $("#txtendtime_" + tskID).val(sResTime[0] + ":" + sResTime[1] + ":00");
                                            $("#changeTasksDates_" + tskID).fadeIn();
                                        }
                                    }
                                }
                                $("#txtenddate_" + tskID).prop('disabled', false);
                                $("#txtendtime_" + tskID).prop('disabled', false);
                                $("#changeTasksDates_" + tskID).fadeIn();
                            },
                            statusCode: {
                                404: function (content) {
                                    alert('cannot find resource');
                                    $("#txtenddate_" + tskID).prop('disabled', false);
                                    $("#txtendtime_" + tskID).prop('disabled', false);
                                    $("#changeTasksDates_" + tskID).fadeIn();
                                },
                                500: function (content) {
                                    alert('internal server error');
                                    $("#txtenddate_" + tskID).prop('disabled', false);
                                    $("#txtendtime_" + tskID).prop('disabled', false);
                                    $("#changeTasksDates_" + tskID).fadeIn();
                                }
                            },
                            error: function (data) {
                                alert("@ResAddSalesOrder.RescheduleTasksManually.lblErrorGeneric");
                                $("#txtenddate_" + tskID).prop('disabled', false);
                                $("#txtendtime_" + tskID).prop('disabled', false);
                                $("#changeTasksDates_" + tskID).fadeIn();
                            }

                        });
                    }
                    else {
                        alert("@ResAddSalesOrder.RescheduleTasksManually.lblErrorDateInThePast");
                    }
                }
            });

            $("#tblchangedates").on("change", ".txtstarttime", function () {
                var currObj = $(this);
                var spID = currObj.attr("id").split('_');
                var tskID = spID[1];
                if (tskID != null && tskID != -1) {
                    var tskDate = $("#txtstartdate_" + tskID).val();
                    var tskTime = $("#txtstarttime_" + tskID).val();
                    var aDate = tskDate.split('/');
                    var aTime = tskTime.split(':');
                    
                    var startdate = new Date(aDate[2], (aDate[1]-1), aDate[0], aTime[0], aTime[1], 0);
                    //alert(aDate[0] + "/" + aDate[1] + "/" + aDate[2] + " " + aTime[0] + ":" + aTime[1] + ":" + aTime[2]);
                    var now = new Date();
                    if (startdate > now) {
                        $("#txtenddate_" + tskID).prop('disabled', true);
                        $("#txtendtime_" + tskID).prop('disabled', true);
                        $("#changeTasksDates_" + tskID).fadeOut();
                        $.ajax({
                            url: "@Url.Action("GetFinishDateByStart", "SalesOrder")",
                            type: 'POST',
                            data: {
                                TaskID: tskID,
                                start: aDate[0] +"/"+ aDate[1] + "/"+ aDate[2] +" "+ aTime[0]+":"+ aTime[1]+":00"
                            },
                            success: function (result) {
                                var aRes = result.split(' ');
                                if (aRes != null && aRes.length==2) {
                                    var aResDate = aRes[0];
                                    var aResTime = aRes[1];
                                    var sResDate = aResDate.split('/');
                                    var sResTime = aResTime.split(':');
                                    if (sResDate != null && sResTime != null && sResDate.length == 3 && (sResTime.length==3||sResTime.length == 2)) {
                                        var newenddate = new Date(sResDate[2], sResDate[1], sResDate[0], sResTime[0], sResTime[1], 0);
                                        if (newenddate > (new Date(1970, 1, 1)) && newenddate > now && newenddate >= startdate) {
                                            $("#txtenddate_" + tskID).val(sResDate[1] + "/" + sResDate[0] + "/" + sResDate[2]);
                                            $("#txtendtime_" + tskID).val(sResTime[0] + ":" + sResTime[1] + ":00");
                                        }
                                        else {
                                            
                                        }
                                        
                                    }
                                }
                                $("#txtenddate_" + tskID).prop('disabled', false);
                                $("#txtendtime_" + tskID).prop('disabled', false);
                                $("#changeTasksDates_" + tskID).fadeIn();
                            },
                            statusCode: {
                                404: function (content) {
                                    alert('cannot find resource');
                                    $("#txtenddate_" + tskID).prop('disabled', false);
                                    $("#txtendtime_" + tskID).prop('disabled', false);
                                    $("#changeTasksDates_" + tskID).fadeIn();
                                },
                                500: function (content) {
                                    alert('internal server error');
                                    $("#txtenddate_" + tskID).prop('disabled', false);
                                    $("#txtendtime_" + tskID).prop('disabled', false);
                                    $("#changeTasksDates_" + tskID).fadeIn();
                                }
                            },
                            error: function (data) {
                                alert("@ResAddSalesOrder.RescheduleTasksManually.lblErrorGeneric");
                                $("#txtenddate_" + tskID).prop('disabled', false);
                                $("#txtendtime_" + tskID).prop('disabled', false);
                                $("#changeTasksDates_" + tskID).fadeIn();
                            }

                        });
                    }
                    else {
                        alert("@ResAddSalesOrder.RescheduleTasksManually.lblErrorDateInThePast");
                    }
                }
            });

            $("#tblchangedates").on("click", ".changeTasksDates", function () {
                var currTask = $(this).val();
                var currObj = $(this);
                currObj.fadeOut();
                var asDate = $("#txtstartdate_" + currTask).val().split('/');
                var asTime = $("#txtstarttime_" + currTask).val().split(':');
                var aeDate = $("#txtenddate_" + currTask).val().split('/');
                var aeTime = $("#txtendtime_" + currTask).val().split(':');

                if (asDate != null && asTime != null && asDate.length == 3 && (asTime.length == 3 || asTime.length==2) &&
                    aeDate != null && aeTime != null && aeDate.length == 3 && (aeTime.length == 3 || aeTime.length == 2)
                ) {
                    var startdate = new Date(asDate[2], (asDate[1]-1), asDate[0], asTime[0], asTime[1], 0);
                    var enddate = new Date(aeDate[2], (aeDate[1]-1), aeDate[0], aeTime[0], aeTime[1], 0);
                    var now = new Date();

                    if (startdate <= enddate && startdate > now) {

                        $("#txtstartdate_" + currTask).prop('disabled', true);
                        $("#txtstarttime_" + currTask).prop('disabled', true);
                        $("#txtenddate_" + currTask).prop('disabled', true);
                        $("#txtendtime_" + currTask).prop('disabled', true);

                        $.ajax({
                            url: "@Url.Action("SaveTaskDates", "SalesOrder")",
                            type: 'POST',
                            data: {
                                TaskID: currTask,
                                start: asDate[0] + "/" + asDate[1] + "/" + asDate[2] + " " + asTime[0] + ":" + asTime[1] + ":00",
                                end: aeDate[0] + "/" + aeDate[1] + "/" + aeDate[2] + " " + aeTime[0] + ":" + aeTime[1] + ":00"
                            },
                            success: function (result) {
                                if (result == "1") {
                                }
                                else if (result == "2") {
                                    alert("@ResAddSalesOrder.RescheduleTasksManually.lblErrNoAuth");
                                }
                                else if (result == "3") {
                                    alert("@ResAddSalesOrder.RescheduleTasksManually.lblErrorDateInThePast");
                                }
                                else {
                                    alert("@ResAddSalesOrder.RescheduleTasksManually.lblErrorGeneric");
                                }

                                $("#txtstartdate_" + currTask).prop('disabled', false);
                                $("#txtstarttime_" + currTask).prop('disabled', false);
                                $("#txtenddate_" + currTask).prop('disabled', false);
                                $("#txtendtime_" + currTask).prop('disabled', false);
                                currObj.fadeIn();
                            },
                            statusCode: {
                                404: function (content) {
                                    alert('cannot find resource');
                                    $("#txtstartdate_" + currTask).prop('disabled', false);
                                    $("#txtstarttime_" + currTask).prop('disabled', false);
                                    $("#txtenddate_" + currTask).prop('disabled', false);
                                    $("#txtendtime_" + currTask).prop('disabled', false);
                                    currObj.fadeIn();
                                },
                                500: function (content) {
                                    alert('internal server error');
                                    $("#txtstartdate_" + currTask).prop('disabled', false);
                                    $("#txtstarttime_" + currTask).prop('disabled', false);
                                    $("#txtenddate_" + currTask).prop('disabled', false);
                                    $("#txtendtime_" + currTask).prop('disabled', false);
                                    currObj.fadeIn();
                                }
                            },
                            error: function (data) {
                                alert("@ResAddSalesOrder.RescheduleTasksManually.lblErrorGeneric");
                                $("#txtstartdate_" + currTask).prop('disabled', false);
                                $("#txtstarttime_" + currTask).prop('disabled', false);
                                $("#txtenddate_" + currTask).prop('disabled', false);
                                $("#txtendtime_" + currTask).prop('disabled', false);
                                currObj.fadeIn();
                            }

                        });
                    }
                    else {
                        alert("@ResAddSalesOrder.RescheduleTasksManually.lblErrorInDates");
                        currObj.fadeIn();
                    }
                }
                else {
                    alert("@ResAddSalesOrder.RescheduleTasksManually.lblErrorInput");
                    currObj.fadeIn();
                }
            });

        });

    </script>

    <div class="row-fluid">
        <div class="span12">
            <table class="table table-striped table-hover" id="tblchangedates">
                <thead>
                    <tr>
                        <th>@ResAddSalesOrder.RescheduleTasksManually.lblTHTask</th>
                        <th>@ResAddSalesOrder.RescheduleTasksManually.lblTHStartDate</th>
                        <th>@ResAddSalesOrder.RescheduleTasksManually.lblTHEndDate</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var m in Model)
                    {
                        <tr>
                            <td>@m.Name</td>
                            <td>
                                <input type="text" class="txtstartdate" id="txtstartdate_@m.TaskProduzioneID" value="@m.LateStart.ToString("dd/MM/yyyy")" style="max-width: 90px;" required />
                                <input type="time" class="txtstarttime" id="txtstarttime_@m.TaskProduzioneID" value="@m.LateStart.ToString("HH:mm:ss")" style="max-width: 130px;" required />
                            </td>
                            <td>
                                <input type="text" class="txtenddate" id="txtenddate_@m.TaskProduzioneID" value="@m.EarlyFinish.ToString("dd/MM/yyyy")" style="max-width: 90px;" required />
                                <input type="time" class="txtendtime" id="txtendtime_@m.TaskProduzioneID" value="@m.EarlyFinish.ToString("HH:mm:ss")" style="max-width: 130px;" required />
                            </td>
                            <td><input type="image" src="~/img/iconSave.jpg" style="min-width:20px; max-width:25px;" id="changeTasksDates_@m.TaskProduzioneID" class="changeTasksDates" value="@m.TaskProduzioneID" /></td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
    <div class="row-fluid">
        <div class="span12">
            <div id="frmLstTaskOperators"></div>
        </div>
    </div>
}
else
{
    <div class="row-fluid">
        <div class="span12">
            @ResAddSalesOrder.RescheduleTasksManually.lblErrNoAuth
        </div>
    </div>
}